name: Test jfrog cli

on:
    push:
        branches:
            - main
    workflow_dispatch:

jobs:
    test1:
        runs-on: ubuntu-latest
        permissions:
            id-token: write
            attestations: write
            contents: read

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup JFrog CLI
              uses: selalererjfrog/setup-jfrog-cli@feature/RTDEV-58178
              with:
                version: latest
              env:
                JF_URL: ${{ secrets.JF_URL }}
                JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}

            - name: Verfiy JFrog CLI
              run: |
                jf --version
                jf c s

            - name: Create artifact
              id: create_artifact
              run: |
                echo "Artifact content" > artifact123.txt
                ARTIFACT_DIGEST=$(sha256sum artifact123.txt | awk '{print "sha256:"$1}')
                echo "artifact_digest=$ARTIFACT_DIGEST" >> $GITHUB_OUTPUT

            - name: Create attestation
              uses: actions/attest@v2
              with:
                subject-digest: ${{ steps.create_artifact.outputs.artifact_digest }}
                subject-name: example-repo-local/artifact123.txt
                predicate-type: "https://example.com/attestations/custom-review-v1"
                predicate: |
                  {
                    "creationTime": "${{ github.event.repository.pushed_at }}",
                    "reviewer": "Sela",
                    "repository": "${{ github.repository }}"
                  }

            - name: Upload artifact
              run: |
                jf rt upload artifact123.txt example-repo-local/artifact123.txt

            - name: Docker login
              uses: docker/login-action@v3
              with:
                registry: ${{ secrets.JF_URL }}
                username: ${{ secrets.DOCKER_USERNAME }}
                password: ${{ secrets.JF_ACCESS_TOKEN }}

            - name: Docker build and push
              uses: docker/build-push-action@v6
              with:
                context: .
                push: true
                tags: ${{ secrets.DOCKER_HOST }}/example-docker-repo-local/docker123:latest
                platforms: linux/amd64

            - name: Calculate docker image digest
              id: docker_digest
              run: |
                DOCKER_DIGEST=$(docker inspect docker123:latest | sha256sum | aws '{print "sha256:"$1}')
                echo "DOCKER_DIGEST=$DOCKER_DIGEST"
                echo "docker_digest=$DOCKER_DIGEST" >> $GITHUB_OUTPUT






